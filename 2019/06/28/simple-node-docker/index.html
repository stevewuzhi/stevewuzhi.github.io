<!DOCTYPE html><html lang="zh-cn"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 简单Docker化一个node.js工程 · stevewuzhi's gitpage</title><meta name="description" content="简单Docker化一个node.js工程 - stevewuzhi"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://stevewuzhi.github.io/atom.xml" title="stevewuzhi's gitpage"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/stevewuzhi/stevewuzhi.github.io" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">简单Docker化一个node.js工程</h1><div class="post-info">2019年6月28日</div><div class="post-content"><p>By stevewuzhi(15322220)</p>
<p>Docker的好处不必赘述, 下面看下怎么简单地docker化一个带mongodb数据库的node.js项目。</p>
<a id="more"></a>
<h2 id="0-安装Docker"><a href="#0-安装Docker" class="headerlink" title="0. 安装Docker"></a>0. 安装Docker</h2><p>使用的是社区版(community edition), 参考<a href="https://docs.docker.com/install/linux/docker-ce/ubuntu/" target="_blank" rel="noopener">https://docs.docker.com/install/linux/docker-ce/ubuntu/</a> </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install     apt-transport-https     ca-certificates     curl     gnupg-agent     software-properties-common</span><br><span class="line">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -</span><br><span class="line">sudo add-apt-repository    <span class="string">"deb [arch=amd64] https://download.docker.com/linux/ubuntu \</span></span><br><span class="line"><span class="string">   <span class="variable">$(lsb_release -cs)</span> \</span></span><br><span class="line"><span class="string">   stable"</span></span><br><span class="line">sudo apt update</span><br><span class="line">sudo apt-get install docker-ce docker-ce-cli containerd.io</span><br></pre></td></tr></table></figure>
<h2 id="1-编写Dockerfile"><a href="#1-编写Dockerfile" class="headerlink" title="1. 编写Dockerfile"></a>1. 编写Dockerfile</h2><p>简而言之, 就是将怎么构建Docker内环境的命令输入进去。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat Dockerfile</span></span><br><span class="line"><span class="comment"># 基础镜像, 使用最新node.js环境</span></span><br><span class="line"><span class="keyword">FROM</span> node:latest</span><br><span class="line"><span class="comment"># 工作目录, ENTRYPOINT的命令将以这里为根路径执行</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /home/node/server</span></span><br><span class="line"><span class="comment"># 如何构建内部环境的命令</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> /home/node \</span></span><br><span class="line"><span class="bash"> &amp;&amp;   git <span class="built_in">clone</span> --branch gyak https://github.com/2019swsad/server \</span></span><br><span class="line"><span class="bash"> &amp;&amp;   <span class="built_in">cd</span> server \</span></span><br><span class="line"><span class="bash"> &amp;&amp;   npm install \</span></span><br><span class="line"><span class="bash"> &amp;&amp;   <span class="built_in">cd</span> app</span></span><br><span class="line"><span class="comment"># 暴露服务端口</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8081</span></span><br><span class="line"><span class="comment"># 启动docker后要在工作目录执行的命令</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">"node"</span>, <span class="string">"app/app.js"</span>]</span></span><br></pre></td></tr></table></figure>
<h2 id="2-构建Docker"><a href="#2-构建Docker" class="headerlink" title="2. 构建Docker"></a>2. 构建Docker</h2><p>在Dockerfile所在目录下执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t gyakkun/2019swsad-server --no-cache .</span><br></pre></td></tr></table></figure>
<h2 id="3-启动Docker"><a href="#3-启动Docker" class="headerlink" title="3. 启动Docker"></a>3. 启动Docker</h2><p>由于数据库独立出来, 所以在服务端内部需要指定数据库的地址。本次后端使用的是koa以及操作数据库中间件monk, 并使用koa-sslify来启用https服务。为了构建更通用的docker并复用主机的https端口, 我们将使用反向代理的方式提供https服务, 因此需要对源码进行一些修改。详见<a href="https://github.com/2019swsad/server/commit/b579077b710c611109404be6f7db04c329ad1165" target="_blank" rel="noopener">commit</a> 及<a href="https://github.com/2019swsad/server/commit/91181301cbc38568fc10a121a78a3b5e37d40901" target="_blank" rel="noopener">commit</a>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// helper/db.js</span></span><br><span class="line"><span class="comment">// const url = 'localhost:27017/data'</span></span><br><span class="line"><span class="keyword">const</span> url = process.env.MONGO_URL || <span class="string">'localhost:27017/data'</span></span><br></pre></td></tr></table></figure>
<p>然后在docker 运行命令中加入环境变量, 注意引号的用法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 18081:8081 \</span><br><span class="line">    -e <span class="string">"MONGO_URL=172.17.0.1:27017/data"</span> \</span><br><span class="line">    -e <span class="string">"NODE_APP_INSTANCE=8081"</span> gyakkun/2019swsad-server</span><br></pre></td></tr></table></figure>
<p>实际上数据库是ssh转发远程数据库得来的, 附上命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -C - 开启压缩</span></span><br><span class="line"><span class="comment"># -f - daemon化, 即使当前会话终端也不会停止转发</span></span><br><span class="line"><span class="comment"># -N - 不打开远程shell</span></span><br><span class="line"><span class="comment"># -L - 本地转发</span></span><br><span class="line"><span class="comment"># 前一半的127.0.0.1:27017 - 在本地的127.0.0.1环回地址打开socket监听27017端口</span></span><br><span class="line"><span class="comment"># 后一半的127.0.0.1:27017 - 将上述socket得到的请求转发到远程主机, 远程主机再将请求转发到自己的127.0.0.1:27017</span></span><br><span class="line">ssh -C -f -N -L 127.0.0.1:27017:127.0.0.1:27017 root@<span class="variable">$DOMAIN</span></span><br></pre></td></tr></table></figure>
</div></article></div></main><footer><div class="paginator"><a href="/2019/06/28/simple-nginx-reverse-proxy/" class="prev">上一篇</a><a href="/2019/05/26/swad-hw7/" class="next">下一篇</a></div><div class="copyright"><p>© 2019 <a href="https://stevewuzhi.github.io">stevewuzhi</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>